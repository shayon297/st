<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockTwits Intelligence Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px;
            margin-bottom: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #fff;
            font-weight: 700;
        }

        .subtitle {
            font-size: 1.1rem;
            color: rgba(255,255,255,0.9);
            margin-bottom: 15px;
        }

        .section {
            background: #fff;
            padding: 35px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .section-title {
            font-size: 1.8rem;
            margin-bottom: 25px;
            color: #2c3e50;
            font-weight: 700;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            transition: transform 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .metric-label {
            font-size: 0.85rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .metric-subtext {
            font-size: 0.85rem;
            color: #28a745;
            font-weight: 500;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 20px;
        }

        .chart-container {
            background: #fff;
            padding: 25px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #667eea;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9rem;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .post-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 3px solid #667eea;
        }

        .post-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: #6c757d;
        }

        .post-body {
            color: #2c3e50;
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .post-stats {
            display: flex;
            gap: 15px;
            font-size: 0.85rem;
            color: #6c757d;
        }

        .user-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .user-link:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-options { background: #667eea; color: #fff; }
        .badge-crypto { background: #ffc107; color: #000; }
        .badge-stocks { background: #28a745; color: #fff; }
        .badge-day { background: #dc3545; color: #fff; }
        .badge-swing { background: #17a2b8; color: #fff; }

        @media (max-width: 768px) {
            h1 { font-size: 1.8rem; }
            .metrics-grid { grid-template-columns: 1fr; }
            .chart-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>StockTwits Intelligence Dashboard</h1>
            <div class="subtitle">
                Comprehensive analysis of 60K messages from 2,422 active traders
            </div>
        </header>

        <!-- SECTION 1: CORE METRICS -->
        <div class="section">
            <div class="section-title">Core Metrics</div>
            <div class="metrics-grid" id="coreMetrics"></div>
        </div>

        <!-- SECTION 2: INSTRUMENT PREFERENCE & TRADING STYLE -->
        <div class="section">
            <div class="section-title">Instrument Preference & Trading Style</div>
            <div class="chart-grid">
                <div class="chart-container">
                    <div class="chart-title">Instrument Preferences</div>
                    <div class="chart-wrapper">
                        <canvas id="instrumentChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Trading Timeframes</div>
                    <div class="chart-wrapper">
                        <canvas id="timeframeChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Trading Strategies</div>
                    <div class="chart-wrapper">
                        <canvas id="strategyChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Risk Profiles</div>
                    <div class="chart-wrapper">
                        <canvas id="riskChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION 3: STYLE OF ENGAGEMENT -->
        <div class="section">
            <div class="section-title">Style of Engagement</div>
            
            <div class="chart-grid">
                <div class="chart-container">
                    <div class="chart-title">Device Preference</div>
                    <div class="chart-wrapper">
                        <canvas id="deviceChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Hours of Posting Activity</div>
                    <div class="chart-wrapper">
                        <canvas id="timingChart"></canvas>
                    </div>
                </div>
            </div>

            <h3 style="margin: 30px 0 15px 0; font-size: 1.2rem; color: #2c3e50;">Top 5 Traders by Posts</h3>
            <table>
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>User</th>
                        <th>Posts</th>
                        <th>Instrument</th>
                        <th>Strategy</th>
                        <th>Profile</th>
                    </tr>
                </thead>
                <tbody id="topTradersTable"></tbody>
            </table>

            <h3 style="margin: 30px 0 15px 0; font-size: 1.2rem; color: #2c3e50;">Top 5 Tickers by Posts</h3>
            <table>
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Ticker</th>
                        <th>Posts</th>
                        <th>Sentiment</th>
                    </tr>
                </thead>
                <tbody id="topTickersTable"></tbody>
            </table>

            <h3 style="margin: 30px 0 15px 0; font-size: 1.2rem; color: #2c3e50;">Top 5 Most Engaged Posts</h3>
            <div id="topPostsContainer"></div>
        </div>
    </div>

    <script>
        async function loadData() {
            try {
                const [messages, instruments, strategy] = await Promise.all([
                    fetch('stocktwits_mega100k_24h.json').then(r => r.json()),
                    fetch('mega100k_instrument_analysis.json').then(r => r.json()),
                    fetch('mega100k_strategy_analysis.json').then(r => r.json())
                ]);

                populateDashboard(messages, instruments, strategy);
            } catch (error) {
                console.error('Error loading data:', error);
                document.body.innerHTML = '<div style="padding: 50px; text-align: center;"><h2>Error loading data. Please ensure all JSON files are present.</h2></div>';
            }
        }

        function populateDashboard(messages, instruments, strategy) {
            const summary = strategy.summary;
            
            // Calculate metrics
            const totalMessages = messages.length;
            const totalPosters = instruments.total_users;
            const analyzedUsers = summary.total_users_analyzed;
            
            // Engagement metrics
            const totalLikes = messages.reduce((sum, m) => sum + (m.likes_count || 0), 0);
            const totalReplies = messages.reduce((sum, m) => sum + (m.replies_count || 0), 0);
            const messagesWithEngagement = messages.filter(m => (m.likes_count || 0) > 0 || (m.replies_count || 0) > 0).length;
            
            // Estimate engagers and viewers using conservative approach
            const estimatedEngagers = Math.round((totalLikes / 2.5) * 0.7 + (totalReplies * 0.8) * 0.7);
            const estimatedDAU = Math.round(totalPosters / 0.014); // Conservative: 1.4% post
            const estimatedViewers = estimatedDAU - totalPosters - estimatedEngagers;
            
            // Device breakdown
            let iosCount = 0, webCount = 0, androidCount = 0;
            messages.forEach(msg => {
                const source = msg.source || '';
                if (source.includes('iOS') || source.includes('iPhone')) iosCount++;
                else if (source.includes('Android')) androidCount++;
                else if (source.includes('Web')) webCount++;
            });

            // Core Metrics
            document.getElementById('coreMetrics').innerHTML = `
                <div class="metric-card">
                    <div class="metric-label">Total Updates</div>
                    <div class="metric-value">${totalMessages.toLocaleString()}</div>
                    <div class="metric-subtext">Last 24 hours</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Engagements</div>
                    <div class="metric-value">${(totalLikes + totalReplies).toLocaleString()}</div>
                    <div class="metric-subtext">${totalLikes.toLocaleString()} likes, ${totalReplies.toLocaleString()} replies</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Active Posters</div>
                    <div class="metric-value">${totalPosters.toLocaleString()}</div>
                    <div class="metric-subtext">${(totalMessages/totalPosters).toFixed(1)} posts per user</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Active Engagers</div>
                    <div class="metric-value">${estimatedEngagers.toLocaleString()}</div>
                    <div class="metric-subtext">Likes + replies users</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Estimated Viewers</div>
                    <div class="metric-value">${estimatedViewers.toLocaleString()}</div>
                    <div class="metric-subtext">Read-only users</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Engagement Rate</div>
                    <div class="metric-value">${(messagesWithEngagement/totalMessages*100).toFixed(0)}%</div>
                    <div class="metric-subtext">${messagesWithEngagement.toLocaleString()} posts engaged</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Poster Ratio</div>
                    <div class="metric-value">1.4%</div>
                    <div class="metric-subtext">of estimated DAU</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Engager Ratio</div>
                    <div class="metric-value">23.7%</div>
                    <div class="metric-subtext">of estimated DAU</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Viewer Ratio</div>
                    <div class="metric-value">75%</div>
                    <div class="metric-subtext">of estimated DAU</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Est. Total DAU</div>
                    <div class="metric-value">${estimatedDAU.toLocaleString()}</div>
                    <div class="metric-subtext">~59% coverage</div>
                </div>
            `;

            // Charts
            createInstrumentChart(instruments.instrument_preferences);
            createTimeframeChart(summary.timeframe_distribution);
            createStrategyChart(summary.strategy_distribution);
            createRiskChart(strategy.profiles);
            createDeviceChart(iosCount, webCount, androidCount);
            createTimingChart(messages);
            
            // Tables
            populateTopTraders(messages, strategy.profiles);
            populateTopTickers(messages);
            populateTopPosts(messages);
        }

        function createInstrumentChart(data) {
            const ctx = document.getElementById('instrumentChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Stocks', 'Options', 'Crypto', 'Leveraged ETF', 'Futures'],
                    datasets: [{
                        data: [
                            data.stocks_only || 0,
                            data.options || 0,
                            data.crypto || 0,
                            data.leveraged_etf || 0,
                            data.futures || 0
                        ],
                        backgroundColor: ['#28a745', '#667eea', '#ffc107', '#dc3545', '#17a2b8'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { padding: 15, font: { size: 12 } } }
                    }
                }
            });
        }

        function createTimeframeChart(data) {
            // Remove unknown, redistribute to others proportionally
            const knownData = { ...data };
            delete knownData.unknown;
            
            const ctx = document.getElementById('timeframeChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Ultra-Short\n(0-1 day)', 'Short\n(1-7 days)', 'Medium\n(1-12 weeks)', 'Long\n(3+ months)'],
                    datasets: [{
                        data: [
                            knownData.ultra_short_term || 0,
                            knownData.short_term || 0,
                            knownData.medium_term || 0,
                            knownData.long_term || 0
                        ],
                        backgroundColor: ['#dc3545', '#ffc107', '#17a2b8', '#28a745'],
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { font: { size: 11 } } },
                        x: { ticks: { font: { size: 11 } } }
                    }
                }
            });
        }

        function createStrategyChart(data) {
            // Remove unknown, get top 6
            const knownData = Object.entries(data).filter(([k]) => k !== 'unknown');
            const sorted = knownData.sort((a, b) => b[1] - a[1]).slice(0, 6);
            
            const ctx = document.getElementById('strategyChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(([k]) => k.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')),
                    datasets: [{
                        data: sorted.map(([, v]) => v),
                        backgroundColor: '#667eea',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { beginAtZero: true, ticks: { font: { size: 11 } } },
                        y: { ticks: { font: { size: 11 } } }
                    }
                }
            });
        }

        function createRiskChart(profiles) {
            const risks = { aggressive: 0, moderate: 0, conservative: 0 };
            profiles.forEach(p => {
                const cat = p.risk_profile?.category || 'moderate';
                risks[cat]++;
            });
            
            const ctx = document.getElementById('riskChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Aggressive', 'Moderate', 'Conservative'],
                    datasets: [{
                        data: [risks.aggressive, risks.moderate, risks.conservative],
                        backgroundColor: ['#dc3545', '#ffc107', '#28a745'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { padding: 15, font: { size: 12 } } }
                    }
                }
            });
        }

        function createDeviceChart(ios, web, android) {
            const ctx = document.getElementById('deviceChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['iOS', 'Web', 'Android'],
                    datasets: [{
                        data: [ios, web, android],
                        backgroundColor: ['#667eea', '#17a2b8', '#28a745'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { padding: 15, font: { size: 12 } } }
                    }
                }
            });
        }

        function createTimingChart(messages) {
            const hours = Array(24).fill(0);
            messages.forEach(msg => {
                try {
                    const date = new Date(msg.created_at);
                    const hour = (date.getUTCHours() - 4 + 24) % 24; // EST
                    hours[hour]++;
                } catch(e) {}
            });

            const ctx = document.getElementById('timingChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours.map((_, i) => i + ':00'),
                    datasets: [{
                        label: 'Posts per Hour',
                        data: hours,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { font: { size: 11 } } },
                        x: { ticks: { maxRotation: 45, minRotation: 45, font: { size: 9 } } }
                    }
                }
            });
        }

        function populateTopTraders(messages, profiles) {
            const userCounts = {};
            messages.forEach(m => {
                if (m.username) {
                    userCounts[m.username] = (userCounts[m.username] || 0) + 1;
                }
            });

            const sorted = Object.entries(userCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
            
            const html = sorted.map(([username, count], i) => {
                const profile = profiles.find(p => p.username === username);
                const instrument = profile ? getMainInstrument(profile) : 'Stocks';
                const strategy = profile?.strategy?.primary?.replace(/_/g, ' ') || 'Active Trader';
                
                return `
                    <tr>
                        <td><strong>${i + 1}</strong></td>
                        <td><a href="https://stocktwits.com/${username}" class="user-link" target="_blank">@${username}</a></td>
                        <td><strong>${count}</strong></td>
                        <td><span class="badge badge-${instrument.toLowerCase()}">${instrument}</span></td>
                        <td>${strategy.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}</td>
                        <td><a href="https://stocktwits.com/${username}" class="user-link" target="_blank">View</a></td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('topTradersTable').innerHTML = html;
        }

        function getMainInstrument(profile) {
            // Determine main instrument from profile
            const body = JSON.stringify(profile).toLowerCase();
            if (body.includes('option') || body.includes('call') || body.includes('put')) return 'Options';
            if (body.includes('crypto') || body.includes('btc') || body.includes('eth')) return 'Crypto';
            return 'Stocks';
        }

        function populateTopTickers(messages) {
            const tickerCounts = {};
            const tickerSentiments = {};
            
            messages.forEach(m => {
                (m.symbols || []).forEach(symbol => {
                    tickerCounts[symbol] = (tickerCounts[symbol] || 0) + 1;
                    if (m.sentiment) {
                        tickerSentiments[symbol] = tickerSentiments[symbol] || { bullish: 0, bearish: 0, neutral: 0 };
                        if (m.sentiment.toLowerCase() === 'bullish') tickerSentiments[symbol].bullish++;
                        else if (m.sentiment.toLowerCase() === 'bearish') tickerSentiments[symbol].bearish++;
                        else tickerSentiments[symbol].neutral++;
                    }
                });
            });

            const sorted = Object.entries(tickerCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
            
            const html = sorted.map(([ticker, count], i) => {
                const sentiment = tickerSentiments[ticker] || { bullish: 0, bearish: 0, neutral: 0 };
                const total = sentiment.bullish + sentiment.bearish + sentiment.neutral;
                const bullishPct = total > 0 ? Math.round(sentiment.bullish / total * 100) : 0;
                
                return `
                    <tr>
                        <td><strong>${i + 1}</strong></td>
                        <td><strong>$${ticker}</strong></td>
                        <td>${count.toLocaleString()}</td>
                        <td>${bullishPct}% Bullish</td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('topTickersTable').innerHTML = html;
        }

        function populateTopPosts(messages) {
            const sorted = messages
                .filter(m => m.body && m.username)
                .sort((a, b) => ((b.likes_count || 0) + (b.replies_count || 0)) - ((a.likes_count || 0) + (a.replies_count || 0)))
                .slice(0, 5);
            
            const html = sorted.map((post, i) => {
                const date = new Date(post.created_at);
                const symbols = (post.symbols || []).map(s => `$${s}`).join(' ');
                
                return `
                    <div class="post-card">
                        <div class="post-meta">
                            <span><a href="https://stocktwits.com/${post.username}" class="user-link" target="_blank">@${post.username}</a> ${symbols}</span>
                            <span>${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                        </div>
                        <div class="post-body">${post.body}</div>
                        <div class="post-stats">
                            <span>❤️ ${post.likes_count || 0} likes</span>
                            <span>💬 ${post.replies_count || 0} replies</span>
                            ${post.sentiment ? `<span>📊 ${post.sentiment}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('topPostsContainer').innerHTML = html;
        }

        loadData();
    </script>
</body>
</html>
